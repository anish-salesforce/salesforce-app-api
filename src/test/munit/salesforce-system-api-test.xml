<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:munit="http://www.mulesoft.org/schema/mule/munit"
      xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="
        http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
        http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
        http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd">

  <munit:config name="munit"/>

  <!-- Test flows that replicate the main app flows -->
  <flow name="test-health-flow">
    <ee:transform doc:name="Transform Message">
      <ee:message>
        <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
"api is alive now" as String {encoding: "UTF-8", mediaType: "application/json"}]]></ee:set-payload>
      </ee:message>
    </ee:transform>
  </flow>

  <flow name="test-post-accounts-flow">
    <ee:transform doc:name="Transform Message">
      <ee:message>
        <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  id: "0015g00000XYZ123AAZ",
  success: true,
  errors: []
}]]></ee:set-payload>
      </ee:message>
    </ee:transform>
  </flow>

  <!-- Updated MUnit tests for Java 17 compatibility -->
  <munit:test name="health_flow_returns_alive" description="GET /health returns alive message">
    <munit:execution>
      <munit:flow-ref name="test-health-flow"/>
    </munit:execution>
    <munit:validation>
      <!-- Updated assertion syntax for Java 17 compatibility -->
      <munit:assert-that expression="#[(payload default '') as String]" 
                      is="#['api is alive now']"/>
    </munit:validation>
  </munit:test>

  <munit:test name="post_accounts_returns_success" description="POST /accounts returns id and success=true">
    <munit:execution>
      <munit:flow-ref name="test-post-accounts-flow"/>
    </munit:execution>
    <munit:validation>
      <!-- Java 17 compatible assertions -->
      <munit:assert-that expression="#[(payload.id default null)]" is="#[(value) -> value != null]"/>
      <munit:assert-that expression="#[(payload.success default false)]" is="#[(value) -> value == true]"/>
      <munit:assert-that expression="#[(payload.errors default []) size]" is="#[(value) -> value == 0]"/>
    </munit:validation>
  </munit:test>

</mule>